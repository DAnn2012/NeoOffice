--- makefile.mk	2013-08-13 04:46:06.000000000 -0700
+++ makefile.mk	2014-04-25 19:26:33.000000000 -0700
@@ -32,23 +32,30 @@
 
 # --- Files --------------------------------------------------------
 
-.IF "$(ENABLE_NSS_MODULE)"!="YES"
+.IF "$(ENABLE_NSS_MODULE)"!="YES" && ("$(OS)"!="MACOSX" || "$(UPD)"!="310")
 
 all:
 	@echo "NSS will not be built. ENABLE_NSS_MODULE is '$(ENABLE_NSS_MODULE)'"
 
 .ELSE
 
+.IF "$(OS)"=="MACOSX" && "$(UPD)"=="310"
+TARFILE_NAME=nss-3.16-with-nspr-4.10.4
+TARFILE_MD5=324e5b83e4b44ca612aec1d960625b21
+TARFILE_ROOTDIR=nss-3.16
+PATCH_FILE_NAME=nss_macosx.patch
+.ELSE	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 TARFILE_NAME=nss-3.12.6-with-nspr-4.8.4
 TARFILE_MD5=b92261a5679276c400555004937af965
 TARFILE_ROOTDIR=nss-3.12.6
 PATCH_FILES=nss.patch
+.ENDIF	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 
-.IF "$(OS)"=="MACOSX"
+.IF "$(OS)"=="MACOSX" && "$(UPD)"!="310"
 MACOS_SDK_DIR=/Developer/SDKs/MacOSX10.4u.sdk
 .EXPORT : MACOS_SDK_DIR
 PATCH_FILES+=nss_macosx.patch
-.ENDIF # "$(OS)"=="MACOSX"
+.ENDIF # "$(OS)"=="MACOSX" && "$(UPD)"!="310"
 
 .IF "$(debug)" != ""
 .ELSE
@@ -80,11 +87,27 @@
 CC:=gcc $(EXTRA_CFLAGS)
 .EXPORT : CPP
 .ENDIF # "$(EXTRA_CFLAGS)"!=""
+.IF "$(UPD)"=="310"
+# force 64-bit buildmode
+USE_64:=1
+.EXPORT : USE_64
+# force use of system sqlite
+NSS_USE_SYSTEM_SQLITE:=1
+.EXPORT : NSS_USE_SYSTEM_SQLITE
+.ENDIF	# "$(UPD)"=="310"
 .ENDIF # "$(OS)"=="MACOSX"
 
+.IF "$(OS)"=="MACOSX" && "$(UPD)"=="310"
+OUT2LIB=dist$/out$/lib$/*$(DLLPOST)
+.ELSE	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 OUT2LIB=mozilla$/dist$/out$/lib$/*$(DLLPOST)
+.ENDIF	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 
+.IF "$(OS)"=="MACOSX" && "$(UPD)"=="310"
+BUILD_DIR=nss
+.ELSE	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 BUILD_DIR=mozilla$/security$/nss
+.ENDIF	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 BUILD_ACTION= $(GNUMAKE) nss_build_all
 #See #i105566# && moz#513024#
 .IF "$(OS)"=="LINUX"
@@ -171,7 +194,11 @@
 .ENDIF			# "$(GUI)"=="WNT"
 
 
+.IF "$(OS)"=="MACOSX" && "$(UPD)"=="310"
+OUTDIR2INC=dist$/public$/nss dist$/out$/include
+.ELSE	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 OUTDIR2INC=mozilla$/dist$/public$/nss mozilla$/dist$/out$/include
+.ENDIF	# "$(OS)"=="MACOSX" && "$(UPD)"=="310"
 
 # --- Targets ------------------------------------------------------
 
--- nss_macosx.patch	2013-08-13 04:46:06.000000000 -0700
+++ nss_macosx.patch	2014-04-25 19:22:14.000000000 -0700
@@ -1,12 +1,64 @@
---- misc/nss-3.12.6/mozilla/security/nss/Makefile	2008-12-03 00:24:39.000000000 +0100
-+++ misc/build/nss-3.12.6/mozilla/security/nss/Makefile	2009-11-27 13:36:22.662753328 +0100
-@@ -104,6 +104,9 @@
- ifeq ($(OS_TARGET),WIN95)
- NSPR_CONFIGURE_OPTS += --enable-win32-target=WIN95
+--- misc/build/nss-3.16/nspr/config/rules.mk	2009-12-09 22:24:37.000000000 +0100
++++ misc/build/nss-3.16/nspr/config/rules.mk	2010-06-11 16:35:54.946870871 +0200
+@@ -345,7 +345,12 @@
+ ifdef NS_USE_GCC
+ 	$(RC) $(RCFLAGS) $(filter-out -U%,$(DEFINES)) $(INCLUDES:-I%=--include-dir %) -o $@ $<
+ else
+-	$(RC) $(RCFLAGS) $(filter-out -U%,$(DEFINES)) $(INCLUDES) -Fo$@ $<
++        #We remove stl from the paths to avoid that rc.exe finds the stlport of
++        #OOo. stlport includes the system stl which will fail. By removing it,
++        #rc will use the stl from the system if the path is in the INCLUDE
++        #variable.
++	INCLUDE="$(subst /stl,,$(INCLUDE))" $(RC) $(RCFLAGS) $(filter-out -U%,$(DEFINES)) $(INCLUDES) -Fo$@ $<
++
+ endif # GCC
+ 	@echo $(RES) finished
  endif
-+ifdef MACOS_SDK_DIR
-+NSPR_CONFIGURE_OPTS += --with-macos-sdk=$(MACOS_SDK_DIR)
-+endif
- ifdef USE_DEBUG_RTL
- NSPR_CONFIGURE_OPTS += --enable-debug-rtl
+--- misc/build/nss-3.16/nss/coreconf/Darwin.mk	2014-04-25 19:12:44.000000000 -0700
++++ misc/build/nss-3.16/nss/coreconf/Darwin.mk	2014-04-25 19:14:35.000000000 -0700
+@@ -7,8 +7,11 @@
+ 
+ DEFAULT_COMPILER = gcc
+ 
+-CC		= gcc
+-CCC		= g++
++# CC is taken from environment automatically.
++#CC		= gcc
++# Use CCC from environment.
++#CCC		= g++
++CCC		= $(CXX)
+ RANLIB		= ranlib
+ 
+ ifndef CPU_ARCH
+--- misc/build/nss-3.16/nss/coreconf/arch.mk	2009-06-05 04:14:49.000000000 +0200
++++ misc/build/nss-3.16/nss/coreconf/arch.mk	2010-06-11 16:35:54.990913282 +0200
+@@ -324,7 +324,12 @@
+ # IMPL_STRATEGY may be defined too.
+ #
+ 
+-OBJDIR_NAME = $(OS_TARGET)$(OS_RELEASE)$(CPU_TAG)$(COMPILER_TAG)$(LIBC_TAG)$(IMPL_STRATEGY)$(OBJDIR_TAG).OBJ
++# OBJDIR_NAME is used to build the directory containing the built objects, for 
++# example mozilla/dist/Linux2.6_x86_glibc_PTH_DBG.OBJ
++# We need to deliver the contents of that folder into the solver. To make that easier
++# in the makefile we rename this directory to "out". 
++#OBJDIR_NAME = $(OS_TARGET)$(OS_RELEASE)$(CPU_TAG)$(COMPILER_TAG)$(LIBC_TAG)$(IMPL_STRATEGY)$(OBJDIR_TAG).OBJ
++OBJDIR_NAME = out
+ 
+ ifeq (,$(filter-out WIN%,$(OS_TARGET)))
+ ifndef BUILD_OPT
+--- misc/build/nss-3.16/nss/coreconf/rules.mk	2009-12-08 02:33:36.000000000 +0100
++++ misc/build/nss-3.16/nss/coreconf/rules.mk	2010-06-11 16:35:54.996448704 +0200
+@@ -355,7 +355,12 @@
+ ifdef NS_USE_GCC
+ 	$(RC) $(filter-out -U%,$(DEFINES)) $(INCLUDES:-I%=--include-dir %) -o $@ $<
+ else
+-	$(RC) $(filter-out -U%,$(DEFINES)) $(INCLUDES) -Fo$@ $<
++        #We remove stl from the paths to avoid that rc.exe finds the stlport of
++        #OOo. stlport includes the system stl which will fail. By removing it,
++        #rc will use the stl from the system if the path is in the INCLUDE
++        #variable.
++	INCLUDE="$(subst /stl,,$(INCLUDE))" $(RC) $(filter-out -U%,$(DEFINES)) $(INCLUDES) -Fo$@ $<
++
+ endif
+ 	@echo $(RES) finished
  endif
