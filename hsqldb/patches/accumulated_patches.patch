--- misc/hsqldb/src/org/hsqldb/persist/HsqlDatabaseProperties.java	2008-03-17 17:05:41.000000000 +0100
+++ misc/build/hsqldb/src/org/hsqldb/persist/HsqlDatabaseProperties.java	2009-01-21 13:09:24.493470142 +0100
@@ -429,6 +429,7 @@
             setProperty(hsqldb_log_size, 10);
             setProperty(sql_enforce_strict_size, true);
             setProperty(hsqldb_nio_data_file, false);
+			setProperty(hsqldb_lock_file, true);
         }
 
         // OOo end
--- misc/build/hsqldb/src/org/hsqldb/Database.java	2007-12-06 09:50:07.000000000 -0800
+++ misc/build/hsqldb/src/org/hsqldb/Database.java	2007-12-06 09:50:41.000000000 -0800
@@ -227,7 +227,7 @@
                     fileAccessClass =
                         classLoader.loadClass(fileaccess_class_name);
                 }
-                catch (ClassNotFoundException e) {
+                catch (Throwable e) {
                     fileAccessClass = Class.forName(fileaccess_class_name);
                 }
                 Constructor constructor =
--- misc/build/hsqldb/src/org/hsqldb/DatabaseCommandInterpreter.java	2007-12-06 10:12:05.000000000 -0800
+++ misc/build/hsqldb/src/org/hsqldb/DatabaseCommandInterpreter.java	2007-12-06 10:12:16.000000000 -0800
@@ -1224,9 +1224,7 @@
             t.createPrimaryKey(null, primaryConst.core.mainColArray, true);
 
             if (primaryConst.core.mainColArray != null) {
-                if (primaryConst.constName == null) {
-                    primaryConst.constName = t.makeSysPKName();
-                }
+                primaryConst.constName = t.makeSysPKName();
 
                 Constraint newconstraint =
                     new Constraint(primaryConst.constName, t,
--- misc/build/hsqldb/src/org/hsqldb/persist/HsqlDatabaseProperties.java	2007-12-06 11:42:15.000000000 -0800
+++ misc/build/hsqldb/src/org/hsqldb/persist/HsqlDatabaseProperties.java	2007-12-06 11:43:22.000000000 -0800
@@ -61,7 +61,9 @@
 
     static {
         try {
-            String prop = System.getProperty(hsqldb_method_class_names);
+            // Return an empty string to make sure that security is as tight
+            // as possible by default
+            String prop = System.getProperty(hsqldb_method_class_names, "");
 
             if (prop != null) {
                 accessibleJavaMethodNames = new HashSet();
--- misc/build/hsqldb/src/org/hsqldb/persist/LockFile.java	2007-12-06 10:14:07.000000000 -0800
+++ misc/build/hsqldb/src/org/hsqldb/persist/LockFile.java	2007-12-06 10:15:07.000000000 -0800
@@ -604,6 +604,21 @@
 
         lockFile.setPath(path);
 
+        // Some platforms like Mac OS X cannot lock mounted file systems
+        // so test for such problems so that we can fall back to this
+        // class' locking behavior.
+        try {
+            if (!lockFile.tryLock()) {
+                lockFile = new LockFile();
+                lockFile.setPath(path);
+            }
+            else {
+                lockFile.tryRelease();
+            }
+        } catch (Throwable t) {
+            Trace.printSystemOut(t.toString());
+        }
+
         return lockFile;
     }
 
--- misc/build/hsqldb/src/org/hsqldb/persist/ScaledRAFile.java	2007-12-06 09:55:26.000000000 -0800
+++ misc/build/hsqldb/src/org/hsqldb/persist/ScaledRAFile.java	2007-12-06 09:55:51.000000000 -0800
@@ -97,7 +97,7 @@
                     storageClass =
                         classLoader.loadClass(classname);
                 }
-                catch (ClassNotFoundException e) {
+                catch (Throwable e) {
                     storageClass = Class.forName(classname);
                 }
                 Constructor constructor =
